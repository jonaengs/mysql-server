--echo #########################################################################
--echo # START SET MANUAL HISTOGRAM
--echo #########################################################################

--echo # CREATE TABLE
CREATE TABLE twitter(j JSON);


--echo # INSERT DATA
INSERT INTO twitter VALUES('{"user": {"followers_count": 10}}');



ANALYZE TABLE twitter UPDATE HISTOGRAM ON j
USING DATA '{
  "buckets": [
    [
      "base64:type254:dXNlcl9vYmoudmVyaWZpZWRfYm9vbA==",
      1.0, 0.0, false, true, 2,
      { "type": "singleton",
        "buckets": [[false, 0.9999530185576697], [true, 4.698144233027954e-05]]
      }
    ],
    [
      "base64:type254:dXNlcl9vYmouZm9sbG93ZXJzX2NvdW50X251bQ==",
      1.0, 0.0, 0, 1605806, 3940,
      { "type": "equi-height",
        "buckets": [[18, 0.041606718148985526, 19], [32, 0.0440203188771765, 14], [45, 0.04214111636374314, 13], [55, 0.04117215256775406, 10], [66, 0.040044631059694046, 11], [79, 0.04217635141087001, 13], [92, 0.040367618991690404, 13], [107, 0.04060251930586957, 15], [121, 0.04297501247907919, 14], [137, 0.04245823178788501, 16], [154, 0.04126611269342573, 17], [174, 0.040426344070235196, 20], [195, 0.04126024018557125, 21], [221, 0.04236427166221335, 26], [252, 0.04107819244208239, 31], [280, 0.0406788619079778, 28], [317, 0.04023255131103738, 37], [370, 0.04002114102827613, 53], [430, 0.0405379217194703, 60], [515, 0.0402266788031829, 85], [649, 0.04069647943154124, 134], [873, 0.040027013536130605, 224], [1365, 0.040027013536130605, 471], [4907, 0.04000352350471269, 1492], [1605806, 0.013588983175264998, 1103]]
      }
    ]
  ],
  "histogram-type": "json-flex",
  "data-type": "json",
  "null-values": 0.0,
  "last-updated": "2023-02-27 16:13:14.0",
  "number-of-buckets-specified": 1024,
  "collation-id": 255,
  "sampling-rate": 0.0
}';

# SELECT * FROM information_schema.column_statistics WHERE TABLE_NAME = 'twitter' AND COLUMN_NAME = 'j';
SET OPTIMIZER_TRACE = "enabled=on";

# --echo 
# EXPLAIN SELECT * FROM twitter WHERE j->>"$.user.verified" = FALSE;
# SELECT JSON_EXTRACT(TRACE, "$**.filtering_effect") FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;

--echo
--echo 
--echo 
EXPLAIN SELECT * FROM twitter WHERE j->>"$.user.followers_count" > 5000;
SELECT JSON_EXTRACT(TRACE, "$**.filtering_effect") FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;

--echo
--echo
--echo 
EXPLAIN SELECT * FROM twitter WHERE j->>"$.user.followers_count" < 5000;
SELECT JSON_EXTRACT(TRACE, "$**.filtering_effect") FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;

--echo
--echo
--echo 
EXPLAIN SELECT * FROM twitter WHERE j->>"$.*.verified" <> FALSE;
SELECT JSON_EXTRACT(TRACE, "$**.filtering_effect") FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;
EXPLAIN SELECT * FROM twitter WHERE j->>"$.**.verified" <> TRUE;
SELECT JSON_EXTRACT(TRACE, "$**.filtering_effect") FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;

--echo
--echo
--echo 
EXPLAIN SELECT * FROM twitter WHERE j->>"$.user.followers_count" NOT IN (0, 1, 2, 3, 4);
SELECT JSON_EXTRACT(TRACE, "$**.filtering_effect") FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;
--echo 
EXPLAIN SELECT * FROM twitter WHERE j->>"$.user.verified" NOT IN (TRUE, FALSE);
SELECT JSON_EXTRACT(TRACE, "$**.filtering_effect") FROM INFORMATION_SCHEMA.OPTIMIZER_TRACE;